<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimizador Turbo (Clustering & Inspeção) | Arquivo SEC</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --gov-blue: #1351b4; --bg-body: #f3f4f6; --text-primary: #1f2937;
            --success: #059669; --warning: #d97706; --danger: #dc2626;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg-body); color: var(--text-primary); margin: 0; padding: 20px; display: flex; flex-direction: column; min-height: 100vh; }
        
        .header { background: var(--gov-blue); color: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        
        .grid-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        
        /* Sidebar */
        .sidebar { background: white; padding: 20px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: fit-content; }
        .sidebar h3 { font-size: 14px; text-transform: uppercase; color: var(--gov-blue); border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 0; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; font-weight: 700; color: #555; margin-bottom: 4px; text-transform: uppercase; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        
        .file-drop { border: 2px dashed #ccc; padding: 20px; text-align: center; background: #fafafa; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .file-drop:hover { border-color: var(--gov-blue); background: #eff6ff; }
        .file-drop.active { border-color: var(--success); background: #f0fdf4; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 12px; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--gov-blue); color: white; }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
        
        /* Main Content */
        .main-content { display: flex; flex-direction: column; gap: 20px; }
        
        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stat-box { background: white; padding: 15px; border-radius: 4px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .stat-val { font-size: 24px; font-weight: 900; color: var(--gov-blue); display: block; }
        .stat-lbl { font-size: 10px; text-transform: uppercase; color: #666; font-weight: 700; }
        
        /* Inspector Table */
        .inspector-box { background: #fff; border: 1px solid #e5e7eb; border-radius: 4px; overflow: hidden; font-size: 11px; }
        .inspector-header { background: #f9fafb; padding: 8px 12px; font-weight: 700; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th, td { padding: 6px 10px; border-bottom: 1px solid #eee; white-space: nowrap; }
        th { background: #f3f4f6; color: #374151; font-weight: 700; }
        td { font-family: 'Roboto Mono', monospace; }

        /* Blocks */
        .blocks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .block-card { background: white; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .block-head { background: var(--gov-blue); color: white; padding: 8px 12px; font-weight: 700; font-size: 12px; display: flex; justify-content: space-between; }
        .block-body { padding: 10px; flex: 1; max-height: 150px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 4px; align-content: flex-start; }
        .tag { background: #f3f4f6; border: 1px solid #e5e7eb; padding: 2px 6px; font-size: 10px; border-radius: 3px; font-weight: 600; }
        .block-foot { background: #fdf2f8; color: #be185d; padding: 6px 10px; font-size: 10px; font-weight: 700; border-top: 1px solid #fbcfe8; text-align: right; }

        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--gov-blue); border-radius: 50%; animation: spin 1s infinite; margin: 0 auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 50; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading"><div class="spinner"></div><p style="margin-top:10px; font-weight:700;">Processando Algoritmo...</p></div>

<div class="header">
    <span><i class="fas fa-microchip"></i> OTIMIZADOR "TURBO" (CLUSTERING)</span>
    <span style="font-size:11px; opacity:0.8;">V 3.0 (Posicional)</span>
</div>

<div class="grid-layout">
    
    <aside class="sidebar">
        <h3>1. Arquivos</h3>
        
        <div class="input-group">
            <label>Lista de Eliminação (.xlsx)</label>
            <div class="file-drop" id="dropInput" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-file-excel fa-2x" style="color:#ccc;"></i>
                <div id="nameInput" style="font-size:11px; margin-top:5px;">Clique para carregar</div>
                <input type="file" id="fileInput" hidden accept=".xlsx, .xls" onchange="loadFile(this, 'input')">
            </div>
            <div style="font-size:10px; color:#666; margin-top:5px;">Lê: Box(K), Setor(E), Cod(Q)</div>
        </div>

        <div class="input-group">
            <label>Base Validação (Opcional)</label>
            <div class="file-drop" id="dropBase" onclick="document.getElementById('fileBase').click()">
                <i class="fas fa-database fa-2x" style="color:#ccc;"></i>
                <div id="nameBase" style="font-size:11px; margin-top:5px;">Clique para carregar</div>
                <input type="file" id="fileBase" hidden accept=".xlsx, .xls" onchange="loadFile(this, 'base')">
            </div>
        </div>

        <h3>2. Estratégia</h3>
        
        <div class="input-group">
            <label>Método de Agrupamento</label>
            <select id="sortMethod" class="form-control" style="background:#eef6ff; font-weight:700; border-color:var(--gov-blue);">
                <option value="cluster">CLUSTER (Setor -> Código)</option>
                <option value="original">ORIGINAL (Ordem da Planilha)</option>
            </select>
            <div style="font-size:10px; color:#666; margin-top:4px;">*Cluster: Agrupa itens iguais antes de processar (Gera blocos maiores)</div>
        </div>

        <h3>3. Limites (0 = Infinito)</h3>
        <div class="input-group">
            <label>Max Códigos</label>
            <input type="number" id="limCode" class="form-control" value="30">
        </div>
        <div class="input-group">
            <label>Max Setores</label>
            <input type="number" id="limSector" class="form-control" value="12">
        </div>

        <button class="btn btn-primary" id="btnRun" disabled onclick="runEngine()">
            <i class="fas fa-play"></i> Executar
        </button>
        <button class="btn btn-primary" style="background:#059669;" onclick="exportExcel()">
            <i class="fas fa-download"></i> Baixar Excel
        </button>
    </aside>

    <main class="main-content">
        
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-val" id="valRows">0</span>
                <span class="stat-lbl">Linhas Lidas</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="valBoxes">0</span>
                <span class="stat-lbl">Caixas Únicas</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="valBlocks">0</span>
                <span class="stat-lbl">Blocos Criados</span>
            </div>
            <div class="stat-box" style="border:1px solid var(--gov-blue);">
                <span class="stat-val" id="valMaxBlock">0</span>
                <span class="stat-lbl">Maior Bloco (Cxs)</span>
            </div>
        </div>

        <div class="inspector-box">
            <div class="inspector-header">
                <span><i class="fas fa-microscope"></i> INSPETOR DE DADOS (Primeiras 5 Linhas)</span>
                <span style="font-size:10px; font-weight:400;">Verifique se as colunas estão corretas</span>
            </div>
            <div class="table-wrap">
                <table id="inspectorTable">
                    <thead>
                        <tr><th>Linha Excel</th><th>Box (K)</th><th>Setor (E)</th><th>Código (Q)</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">Aguardando arquivo...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="debugLog" style="background:#fffbe6; padding:10px; border:1px solid #ffe58f; border-radius:4px; font-size:11px; color:#b7791f; display:none;">
            <strong>Diagnóstico do Bloco 1:</strong> <span id="debugText">...</span>
        </div>

        <h3 style="margin:0; font-size:14px; color:#333; text-transform:uppercase;">Visualização dos Blocos</h3>
        <div class="blocks-grid" id="gridBlocks"></div>

    </main>
</div>

<script>
    let rawData = [];
    let baseData = new Set();
    let finalBlocks = [];

    // --- LEITURA E INSPEÇÃO ---
    function loadFile(el, type) {
        const file = el.files[0];
        if(!file) return;

        document.getElementById(type === 'input' ? 'dropInput' : 'dropBase').classList.add('active');
        document.getElementById(type === 'input' ? 'nameInput' : 'nameBase').innerText = file.name;

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            
            if(type === 'base') {
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, {header:1});
                baseData.clear();
                for(let i=3; i<rows.length; i++) { // A4
                    if(rows[i] && rows[i][0]) baseData.add(String(rows[i][0]).trim().toUpperCase());
                }
                alert(`Base carregada: ${baseData.size} caixas validadas.`);
            } else {
                parseInput(wb);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function parseInput(wb) {
        rawData = [];
        const inspectorBody = document.querySelector('#inspectorTable tbody');
        inspectorBody.innerHTML = '';
        
        let previewCount = 0;

        wb.SheetNames.forEach((name, idx) => {
            const ws = wb.Sheets[name];
            const rows = XLSX.utils.sheet_to_json(ws, {header:1});
            let start = (idx === 0) ? 1 : 0; // K2 na aba 1, K1 nas outras

            for(let i=start; i<rows.length; i++) {
                const r = rows[i];
                // Pega dados brutos
                const valBox = r[10]; // K
                const valSet = r[4];  // E
                const valCod = r[16]; // Q

                if(valBox) {
                    // Limpeza Agressiva
                    const cleanBox = String(valBox).trim().toUpperCase();
                    const cleanSet = valSet ? String(valSet).trim().toUpperCase().replace(/\s+/g, ' ') : "N/D";
                    const cleanCod = valCod ? String(valCod).trim().toUpperCase().replace(/\s+/g, ' ') : "N/D";

                    rawData.push({
                        box: cleanBox,
                        setor: cleanSet,
                        cod: cleanCod,
                        rowIdx: i+1,
                        sheet: name
                    });

                    // Popula Inspetor (apenas os 5 primeiros)
                    if(previewCount < 5) {
                        const tr = `<tr>
                            <td>${name} : L${i+1}</td>
                            <td style="font-weight:bold">${cleanBox}</td>
                            <td>${cleanSet}</td>
                            <td>${cleanCod}</td>
                            <td><i class="fas fa-check text-green-500"></i></td>
                        </tr>`;
                        inspectorBody.innerHTML += tr;
                        previewCount++;
                    }
                }
            }
        });

        document.getElementById('valRows').innerText = rawData.length;
        document.getElementById('btnRun').disabled = false;
    }

    // --- ENGINE DE OTIMIZAÇÃO ---
    function runEngine() {
        document.getElementById('loading').style.display = 'flex';

        setTimeout(() => {
            // 1. Configurações
            const limitCode = parseInt(document.getElementById('limCode').value) || Infinity;
            const limitSect = parseInt(document.getElementById('limSector').value) || Infinity;
            if(limitCode === 0) limitCode = Infinity; 
            if(limitSect === 0) limitSect = Infinity;

            const strategy = document.getElementById('sortMethod').value;

            // 2. Agrupamento Inicial (Box Unique)
            let boxMap = new Map();
            rawData.forEach(item => {
                if(!boxMap.has(item.box)) {
                    boxMap.set(item.box, {
                        id: item.box,
                        setores: new Set(),
                        codigos: new Set(),
                        docs: 0
                    });
                }
                let entry = boxMap.get(item.box);
                entry.setores.add(item.setor);
                entry.codigos.add(item.cod);
                entry.docs++;
            });

            // Validação Cruzada (Se base carregada)
            let boxes = Array.from(boxMap.values());
            if(baseData.size > 0) {
                boxes = boxes.filter(b => baseData.has(b.id));
            }

            // 3. ESTRATÉGIA DE ORDENAÇÃO (O SEGREDO DO 687)
            if(strategy === 'cluster') {
                // Ordena por Nome do Setor (Para agrupar setores iguais) + Código
                boxes.sort((a, b) => {
                    const sA = Array.from(a.setores)[0] || "";
                    const sB = Array.from(b.setores)[0] || "";
                    if(sA < sB) return -1;
                    if(sA > sB) return 1;
                    
                    // Se setor igual, agrupa por código
                    const cA = Array.from(a.codigos)[0] || "";
                    const cB = Array.from(b.codigos)[0] || "";
                    return cA.localeCompare(cB);
                });
            }
            // Se 'original', mantém a ordem de leitura (FIFO)

            // 4. Bin Packing
            let blocks = [];
            let currentBlock = newBlock(1);
            let closedBlocks = [];

            // Variável de Debug para o Bloco 1
            let debugReason = "";

            for(let box of boxes) {
                // Tenta colocar no bloco atual
                if(checkFit(currentBlock, box, limitCode, limitSect)) {
                    addToBlock(currentBlock, box);
                } else {
                    // Falhou em entrar. Por quê? (Apenas para o bloco 1)
                    if(currentBlock.id === 1 && !debugReason) {
                        const simCodes = new Set(currentBlock.codes);
                        box.codigos.forEach(c => simCodes.add(c));
                        
                        const simSects = new Set(currentBlock.sects);
                        box.setores.forEach(s => simSects.add(s));
                        
                        debugReason = `Ao tentar adicionar a caixa ${box.id}: Códigos iriam para ${simCodes.size} (Limite ${limitCode}) | Setores iriam para ${simSects.size} (Limite ${limitSect})`;
                    }

                    // Fecha bloco atual e cria novo
                    currentBlock.reason = "Limite Atingido";
                    closedBlocks.push(currentBlock);
                    
                    currentBlock = newBlock(closedBlocks.length + 1);
                    // Adiciona a caixa no novo bloco (assumindo que cabe sozinha)
                    addToBlock(currentBlock, box); 
                }
            }
            closedBlocks.push(currentBlock); // Adiciona o último
            finalBlocks = closedBlocks;

            // 5. Render
            renderResults();
            
            // Debug Log
            const dbg = document.getElementById('debugLog');
            if(debugReason) {
                dbg.style.display = 'block';
                document.getElementById('debugText').innerText = debugReason;
            } else {
                dbg.style.display = 'none';
            }

            document.getElementById('loading').style.display = 'none';

        }, 100);
    }

    function newBlock(id) {
        return {
            id: id,
            boxes: [],
            codes: new Set(),
            sects: new Set(),
            reason: ""
        };
    }

    function checkFit(block, box, maxC, maxS) {
        // Simula união
        let tempC = new Set(block.codes);
        box.codigos.forEach(c => tempC.add(c));
        if(tempC.size > maxC) return false;

        let tempS = new Set(block.sects);
        box.setores.forEach(s => tempS.add(s));
        if(tempS.size > maxS) return false;

        return true;
    }

    function addToBlock(block, box) {
        block.boxes.push(box);
        box.codigos.forEach(c => block.codes.add(c));
        box.setores.forEach(s => block.sects.add(s));
    }

    function renderResults() {
        document.getElementById('valBoxes').innerText = new Set(rawData.map(r=>r.box)).size;
        document.getElementById('valBlocks').innerText = finalBlocks.length;
        
        let max = 0;
        finalBlocks.forEach(b => { if(b.boxes.length > max) max = b.boxes.length; });
        document.getElementById('valMaxBlock').innerText = max;

        const grid = document.getElementById('gridBlocks');
        grid.innerHTML = '';
        
        finalBlocks.forEach(b => {
            const tags = b.boxes.map(bx => `<span class="tag">${bx.id}</span>`).join('');
            const html = `
                <div class="block-card">
                    <div class="block-head">
                        <span>BLOCO ${b.id}</span>
                        <span>${b.boxes.length} Cxs</span>
                    </div>
                    <div style="background:#f8fafc; padding:8px; font-size:10px; border-bottom:1px solid #eee;">
                        <i class="fas fa-barcode"></i> ${b.codes.size} Cód | 
                        <i class="fas fa-building"></i> ${b.sects.size} Set
                    </div>
                    <div class="block-body">${tags}</div>
                    <div class="block-foot">${b.reason || "Finalizado"}</div>
                </div>
            `;
            grid.innerHTML += html;
        });
    }

    function exportExcel() {
        if(!finalBlocks.length) return;
        let data = [];
        finalBlocks.forEach(b => {
            b.boxes.forEach(box => {
                data.push({
                    'Bloco': b.id,
                    'Caixa': box.id,
                    'Qtd Códigos Bloco': b.codes.size,
                    'Qtd Setores Bloco': b.sects.size,
                    'Códigos Caixa': Array.from(box.codigos).join(', '),
                    'Setores Caixa': Array.from(box.setores).join(', ')
                });
            });
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Resultado");
        XLSX.writeFile(wb, "Otimizacao_Turbo.xlsx");
    }

</script>
</body>
</html>
