<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimizador de Eliminação (Diagnóstico Visual) | Arquivo SEC</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --gov-blue: #1351b4;
            --gov-blue-dark: #0c326f;
            --bg-body: #f8f8f8;
            --border-color: #e5e5e5;
            --text-primary: #131313;
            --text-secondary: #555;
            --success: #168821;
            --warning: #ffcd07;
            --danger: #e60000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* Header & Footer */
        .br-header { background: var(--gov-blue); color: white; padding: 8px 0; border-bottom: 4px solid var(--gov-blue-dark); }
        .header-container { max-width: 1400px; margin: 0 auto; padding: 0 20px; font-weight: 700; font-size: 16px; text-transform: uppercase; letter-spacing: 0.5px; }
        .br-footer { background: var(--gov-blue-dark); color: white; padding: 10px 0; font-size: 11px; margin-top: auto; text-align: center; }

        /* Layout */
        .main-container {
            max-width: 1400px; margin: 30px auto; padding: 0 20px; width: 100%;
            display: grid; grid-template-columns: 320px 1fr; gap: 30px; align-items: start;
        }

        /* Sidebar */
        .control-panel {
            background: white; border: 1px solid var(--border-color); border-radius: 4px; padding: 20px;
            position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .panel-title { font-size: 14px; font-weight: 700; color: var(--gov-blue); margin-bottom: 15px; border-bottom: 2px solid var(--gov-blue); padding-bottom: 8px; text-transform: uppercase; }

        .form-group { margin-bottom: 15px; width: 100%; }
        .form-label { display: block; font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 5px; text-transform: uppercase; }
        .form-control {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px;
            font-size: 13px; transition: border-color 0.2s;
        }
        .form-control:focus { border-color: var(--gov-blue); }

        /* Upload Styles */
        .upload-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .file-upload-wrapper {
            border: 2px dashed #ccc; border-radius: 4px; padding: 15px; 
            text-align: center; background: #fafafa; cursor: pointer; transition: all 0.2s;
            width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .file-upload-wrapper.active { border-color: var(--success); background: #f0fff4; }
        .file-upload-wrapper:hover { border-color: var(--gov-blue); background: #eef6ff; }
        .file-upload-wrapper i { font-size: 20px; color: #888; margin-bottom: 8px; }
        .file-upload-wrapper.active i { color: var(--success); }
        .file-upload-text { font-size: 10px; color: #666; font-weight: 500; }
        input[type="file"] { display: none; }

        /* Info Tags */
        .info-tag { font-size: 10px; color: #666; background: #eee; padding: 2px 5px; border-radius: 3px; margin-top: 5px; display: inline-block; }

        /* Botões */
        .btn {
            width: 100%; padding: 10px; border-radius: 3px; font-size: 12px; font-weight: 700; cursor: pointer;
            border: none; display: flex; align-items: center; justify-content: center; gap: 6px; text-transform: uppercase; margin-top: 10px;
            transition: opacity 0.2s;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: var(--gov-blue); color: white; }
        .btn-primary:hover { background: var(--gov-blue-dark); }
        .btn-success { background: var(--success); color: white; }
        
        /* Resultados */
        .results-area { display: flex; flex-direction: column; gap: 20px; }
        
        /* Confirm Bar */
        .confirm-bar {
            background: #eef6ff; border: 1px solid #bdd7f9; color: #1e429f;
            padding: 10px; border-radius: 4px; font-size: 12px; display: flex; justify-content: space-between; align-items: center;
        }
        .confirm-bar strong { font-weight: 900; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 4px; border: 1px solid var(--border-color); text-align: center; }
        .stat-val { font-size: 24px; font-weight: 900; color: var(--gov-blue); display: block; }
        .stat-label { font-size: 10px; text-transform: uppercase; color: #777; font-weight: 700; }

        /* Logs */
        .log-box { background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 15px; display: none; }
        .log-box.error { background: #fff5f5; border-color: #fcc; }
        .log-box.warning { background: #fffbf0; border-color: #ffe08a; }
        
        .log-title { font-size: 12px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; text-transform: uppercase; }
        .log-box.error .log-title { color: var(--danger); }
        .log-box.warning .log-title { color: #d97706; }

        .log-list { list-style: none; font-size: 11px; max-height: 150px; overflow-y: auto; color: #555; }
        .log-list li { padding: 3px 0; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between;}

        /* Blocos Grid */
        .blocks-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .block-card {
            background: white; border: 1px solid var(--border-color); border-radius: 4px;
            overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.03); display: flex; flex-direction: column;
        }
        .block-header {
            background: var(--gov-blue); color: white; padding: 8px 12px;
            font-size: 12px; font-weight: 700; display: flex; justify-content: space-between; align-items: center;
        }
        
        /* Diagnóstico Visual */
        .block-diagnostics {
            padding: 10px; background: #f9fafb; border-bottom: 1px solid #eee;
        }
        .diag-row { margin-bottom: 6px; }
        .diag-label { font-size: 10px; color: #555; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .progress-bar-bg { width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: #10b981; border-radius: 3px; transition: width 0.3s; }
        .progress-bar-fill.warning { background: #f59e0b; }
        .progress-bar-fill.danger { background: #ef4444; }

        .block-content { padding: 10px; flex: 1; display: flex; flex-wrap: wrap; gap: 5px; align-content: flex-start; max-height: 150px; overflow-y: auto; }
        .block-footer {
            background: #fff; padding: 5px 10px; font-size: 10px; color: #666; border-top: 1px solid #eee; text-align: right; font-family: 'Roboto Mono', monospace;
        }
        .box-tag {
            background: #eee; color: #333; padding: 3px 6px; border-radius: 3px; font-size: 10px; font-weight: 700; border: 1px solid #ddd;
        }
        
        /* Loading */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 1000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--gov-blue);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header class="br-header">
        <div class="header-container">
            <i class="fas fa-cubes"></i> Arquivo / Otimizador (Diagnóstico)
        </div>
    </header>

    <main class="main-container">
        
        <aside class="control-panel">
            <div class="panel-title">1. Bases de Dados</div>
            
            <div class="upload-section">
                <label class="form-label">Base de Dados (Sistema)</label>
                <label class="file-upload-wrapper" id="wrapBase" for="fileBase">
                    <i class="fas fa-database"></i>
                    <span class="file-upload-text" id="txtBase">Carregar Base (.xlsx)</span>
                    <input type="file" id="fileBase" accept=".xlsx, .xls" onchange="handleFile(this, 'base')">
                </label>
                <div class="info-tag">Leitura: A4 (Box) / I4 (Total)</div>
            </div>

            <div class="upload-section">
                <label class="form-label">Lista de Eliminação</label>
                <label class="file-upload-wrapper" id="wrapInput" for="fileInput">
                    <i class="fas fa-list-ul"></i>
                    <span class="file-upload-text" id="txtInput">Carregar Lista (.xlsx)</span>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" onchange="handleFile(this, 'input')">
                </label>
                <div class="info-tag" id="sheetInfo">Aguardando arquivo...</div>
                <div style="font-size:9px; color:#666; margin-top:5px;">
                    *Lê K2 (Aba 1) e K1 (Aba 2+)
                </div>
            </div>

            <div class="panel-title" style="margin-top: 10px;">2. Parâmetros</div>

            <div class="form-group">
                <label class="form-label">Max Códigos (un)</label>
                <input type="number" id="configMaxCodes" class="form-control" value="30">
                <div style="font-size:9px; color:#666; margin-top:2px;">Se atingir 30, o bloco fecha.</div>
            </div>

            <div class="form-group">
                <label class="form-label">Max Setores (un)</label>
                <input type="number" id="configMaxSectors" class="form-control" value="12">
                <div style="font-size:9px; color:#666; margin-top:2px;">Se atingir 12, o bloco fecha.</div>
            </div>

            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <button class="btn btn-primary" onclick="runOptimization()" id="btnProcessar" disabled>
                    <i class="fas fa-check-double"></i> Validar e Processar
                </button>
                <button class="btn btn-success" onclick="exportarExcel()" id="btnExportar" disabled>
                    <i class="fas fa-file-excel"></i> Exportar Resultado
                </button>
                 <a href="index.html" class="btn btn-primary" style="background: white; color: #444; border: 1px solid #ccc; text-decoration: none;">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </aside>

        <section class="results-area" id="resultsArea" style="display:none;">
            
            <div class="confirm-bar" id="paramConfirmBar">
                </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-val" id="statProcessed">0</span>
                    <span class="stat-label">Caixas Únicas (Input)</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="statValid">0</span>
                    <span class="stat-label">Válidas (Na Base)</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="statBlocks">0</span>
                    <span class="stat-label">Blocos Gerados</span>
                </div>
            </div>

            <div class="log-box error" id="crossCheckLog">
                <div class="log-title"><i class="fas fa-times-circle"></i> Não Encontradas na Base</div>
                <ul class="log-list" id="errorList"></ul>
            </div>

            <div class="log-box warning" id="complexLog">
                <div class="log-title"><i class="fas fa-exclamation-triangle"></i> Atenção: Caixas Complexas (Isoladas)</div>
                <ul class="log-list" id="complexList"></ul>
            </div>

            <div class="panel-title">Distribuição dos Blocos (Com Diagnóstico)</div>
            <div class="blocks-container" id="blocksContainer"></div>

        </section>

        <section id="emptyState" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #999; text-align: center; padding: 50px;">
            <i class="fas fa-search-location" style="font-size: 50px; margin-bottom: 20px; color: #ddd;"></i>
            <p>Carregue a <strong>Base de Dados</strong> e a <strong>Lista de Eliminação</strong><br>para iniciar a validação.</p>
        </section>

    </main>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div style="font-weight: 700; color: var(--gov-blue);">Processando...</div>
    </div>

    <footer class="br-footer">
        © 2026 Desenvolvido por Vinicius A. de Souza com Claude.ai, Gemini e ChatGPT
    </footer>

    <script>
        // --- ESTADO GLOBAL ---
        let state = {
            validBoxes: new Set(),
            inputDataMap: new Map(),
            finalBlocks: [],
            totalRowsInput: 0
        };

        // --- 1. LEITURA ---
        function handleFile(input, type) {
            const file = input.files[0];
            if(!file) return;

            const wrapId = type === 'base' ? 'wrapBase' : 'wrapInput';
            const txtId = type === 'base' ? 'txtBase' : 'txtInput';
            document.getElementById(wrapId).classList.add('active');
            document.getElementById(txtId).innerText = file.name;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                if(type === 'base') processBaseFile(workbook);
                else processInputFile(workbook);
                checkReady();
            };
            reader.readAsArrayBuffer(file);
        }

        function checkReady() {
            if(state.validBoxes.size > 0 && state.inputDataMap.size > 0) {
                document.getElementById('btnProcessar').disabled = false;
            }
        }

        // --- BASE ---
        function processBaseFile(workbook) {
            const sheetName = workbook.SheetNames[0];
            const ws = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(ws, {header: 1});
            state.validBoxes.clear();
            for(let i = 3; i < rows.length; i++) { // Linha 4
                const row = rows[i];
                if(row && row[0]) state.validBoxes.add(String(row[0]).trim().toUpperCase());
            }
            console.log(`Base: ${state.validBoxes.size} caixas.`);
        }

        // --- INPUT (MULTI-ABAS) ---
        function processInputFile(workbook) {
            state.inputDataMap.clear();
            let totalSheetsRead = 0;
            state.totalRowsInput = 0;

            workbook.SheetNames.forEach((sheetName, sheetIndex) => {
                const ws = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(ws, {header: 1});
                
                let startIndex = (sheetIndex === 0) ? 1 : 0; // K2 na primeira, K1 nas outras
                if(rows.length <= startIndex) return;
                totalSheetsRead++;
                
                for(let i = startIndex; i < rows.length; i++) {
                    const row = rows[i];
                    state.totalRowsInput++;
                    const rawBox = row[10]; // K
                    const rawSetor = row[4]; // E
                    const rawCod = row[16]; // Q

                    if(rawBox) {
                        const boxId = String(rawBox).trim().toUpperCase();
                        if(!state.inputDataMap.has(boxId)) {
                            state.inputDataMap.set(boxId, { id: boxId, setores: new Set(), codigos: new Set() });
                        }
                        const entry = state.inputDataMap.get(boxId);
                        if(rawSetor) entry.setores.add(String(rawSetor).trim().toUpperCase());
                        if(rawCod) entry.codigos.add(String(rawCod).trim());
                    }
                }
            });
            document.getElementById('sheetInfo').innerText = `Lidas: ${totalSheetsRead} Abas | ${state.totalRowsInput} Linhas`;
            document.getElementById('sheetInfo').style.color = 'var(--gov-blue)';
        }

        // --- 2. EXECUÇÃO ---
        function runOptimization() {
            showLoading(true);

            // Lê explicitamente os valores no momento do clique
            const valCodes = document.getElementById('configMaxCodes').value;
            const valSectors = document.getElementById('configMaxSectors').value;
            
            // Tratamento: Se vazio ou 0 -> Infinito
            const limitCodes = (valCodes === "" || valCodes == 0) ? Infinity : parseInt(valCodes);
            const limitSectors = (valSectors === "" || valSectors == 0) ? Infinity : parseInt(valSectors);

            const LIMITS = { boxes: 99999, codes: limitCodes, sectors: limitSectors };

            setTimeout(() => {
                try {
                    const boxesToProcess = [];
                    const notFoundBoxes = [];
                    const complexBoxes = [];

                    state.inputDataMap.forEach(box => {
                        if(!state.validBoxes.has(box.id)) {
                            notFoundBoxes.push(box.id);
                        } else {
                            // Validação inicial
                            if(box.codigos.size > LIMITS.codes || box.setores.size > LIMITS.sectors) {
                                complexBoxes.push(box);
                            } else {
                                boxesToProcess.push(box);
                            }
                        }
                    });

                    // Bin Packing
                    let openBlocks = [];
                    let closedBlocks = [];

                    // Complexas
                    complexBoxes.forEach(box => {
                        closedBlocks.push({
                            id: 0, boxes: [box], codigos: box.codigos, setores: box.setores,
                            reason: "Complexa (Isolada)", satCodes: box.codigos.size, satSectors: box.setores.size
                        });
                    });

                    // Normais
                    for (const box of boxesToProcess) {
                        let placed = false;
                        for (const block of openBlocks) {
                            if (canFit(block, box, LIMITS)) {
                                block.boxes.push(box);
                                box.codigos.forEach(c => block.codigos.add(c));
                                box.setores.forEach(s => block.setores.add(s));
                                placed = true;
                                break;
                            }
                        }
                        if (!placed) {
                            openBlocks.push({
                                id: 0, boxes: [box], codigos: new Set(box.codigos), setores: new Set(box.setores),
                                reason: ""
                            });
                        }
                    }

                    // Define Motivo de Parada
                    openBlocks.forEach(block => {
                        block.satCodes = block.codigos.size;
                        block.satSectors = block.setores.size;
                        
                        if(LIMITS.codes !== Infinity && block.satCodes >= LIMITS.codes) {
                            block.reason = "Limite de Códigos";
                        } else if(LIMITS.sectors !== Infinity && block.satSectors >= LIMITS.sectors) {
                            block.reason = "Limite de Setores";
                        } else {
                            block.reason = "Fim da Lista";
                        }
                    });

                    state.finalBlocks = [...closedBlocks, ...openBlocks];
                    state.finalBlocks.forEach((b, i) => b.id = i + 1);

                    renderResults(state.finalBlocks, notFoundBoxes, complexBoxes, LIMITS);
                    document.getElementById('btnExportar').disabled = false;

                } catch (err) {
                    console.error(err);
                    alert("Erro: " + err.message);
                } finally {
                    showLoading(false);
                }
            }, 100);
        }

        function canFit(block, box, limits) {
            const combinedCodes = new Set(block.codigos);
            box.codigos.forEach(c => combinedCodes.add(c));
            if (combinedCodes.size > limits.codes) return false;

            const combinedSectors = new Set(block.setores);
            box.setores.forEach(s => combinedSectors.add(s));
            if (combinedSectors.size > limits.sectors) return false;

            return true;
        }

        // --- 3. RENDER DIAGNÓSTICO ---
        function renderResults(blocks, notFoundIds, complexBoxes, limits) {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('resultsArea').style.display = 'flex';

            // Barra de Confirmação
            const codesText = limits.codes === Infinity ? "Sem Limite" : limits.codes;
            const sectorsText = limits.sectors === Infinity ? "Sem Limite" : limits.sectors;
            document.getElementById('paramConfirmBar').innerHTML = `
                <span><i class="fas fa-cog"></i> Configuração Aplicada:</span>
                <div>
                    Max Códigos: <strong>${codesText}</strong> &nbsp;|&nbsp; 
                    Max Setores: <strong>${sectorsText}</strong>
                </div>
            `;

            document.getElementById('statProcessed').innerText = state.inputDataMap.size;
            document.getElementById('statValid').innerText = blocks.reduce((acc, b) => acc + b.boxes.length, 0);
            document.getElementById('statBlocks').innerText = blocks.length;

            const errLog = document.getElementById('crossCheckLog');
            if(notFoundIds.length > 0) {
                errLog.style.display = 'block';
                document.getElementById('errorList').innerHTML = notFoundIds.map(id => `<li><span>${id}</span></li>`).join('');
            } else { errLog.style.display = 'none'; }

            const warnLog = document.getElementById('complexLog');
            if(complexBoxes.length > 0) {
                warnLog.style.display = 'block';
                document.getElementById('complexList').innerHTML = complexBoxes.map(b => `<li>Box ${b.id}</li>`).join('');
            } else { warnLog.style.display = 'none'; }

            const container = document.getElementById('blocksContainer');
            container.innerHTML = '';
            
            blocks.forEach(block => {
                const boxTags = block.boxes.map(b => `<span class="box-tag">${b.id}</span>`).join('');
                
                // Cálculos de Porcentagem
                let pctCodes = 0;
                if(limits.codes !== Infinity) pctCodes = Math.min(100, (block.codigos.size / limits.codes) * 100);
                
                let pctSectors = 0;
                if(limits.sectors !== Infinity) pctSectors = Math.min(100, (block.setores.size / limits.sectors) * 100);

                // Classes de cor
                let colorCode = pctCodes >= 100 ? 'danger' : (pctCodes >= 80 ? 'warning' : '');
                let colorSector = pctSectors >= 100 ? 'danger' : (pctSectors >= 80 ? 'warning' : '');

                // Tooltip content (Lista os itens ao passar o mouse)
                const listCodes = Array.from(block.codigos).join('\n');
                const listSectors = Array.from(block.setores).join('\n');

                const html = `
                    <div class="block-card">
                        <div class="block-header">
                            <span>BLOCO #${block.id}</span>
                            <span style="opacity:0.9">${block.boxes.length} Cxs</span>
                        </div>
                        
                        <div class="block-diagnostics">
                            <div class="diag-row" title="${listCodes}">
                                <div class="diag-label">
                                    <span>Códigos</span>
                                    <strong>${block.codigos.size} / ${limits.codes === Infinity ? '∞' : limits.codes}</strong>
                                </div>
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill ${colorCode}" style="width: ${pctCodes}%"></div>
                                </div>
                            </div>
                            
                            <div class="diag-row" title="${listSectors}">
                                <div class="diag-label">
                                    <span>Setores</span>
                                    <strong>${block.setores.size} / ${limits.sectors === Infinity ? '∞' : limits.sectors}</strong>
                                </div>
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill ${colorSector}" style="width: ${pctSectors}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="block-content">${boxTags}</div>
                        <div class="block-footer">
                            Status: ${block.reason}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function exportarExcel() {
            if(!state.finalBlocks.length) return;
            const data = [];
            state.finalBlocks.forEach(b => {
                b.boxes.forEach(box => {
                    data.push({
                        'Bloco': b.id,
                        'Motivo Fechamento': b.reason,
                        'Caixa': box.id,
                        'Qtd Códigos': box.codigos.size,
                        'Qtd Setores': box.setores.size,
                        'Lista Códigos': Array.from(box.codigos).join(', '),
                        'Lista Setores': Array.from(box.setores).join(', ')
                    });
                });
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Diagnostico");
            XLSX.writeFile(wb, "Otimizacao_Diagnostico.xlsx");
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
