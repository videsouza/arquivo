<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimizador de Eliminação | Arquivo SEC</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- DESIGN SYSTEM (AZUL INSTITUCIONAL) --- */
        :root {
            --gov-blue: #1351b4;
            --gov-blue-dark: #0c326f;
            --bg-body: #f8f8f8;
            --border-color: #e5e5e5;
            --text-primary: #131313;
            --text-secondary: #555;
            --success: #168821;
            --warning: #ffcd07;
            --danger: #e60000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* Header & Footer */
        .br-header { background: var(--gov-blue); color: white; padding: 8px 0; border-bottom: 4px solid var(--gov-blue-dark); }
        .header-container { max-width: 1400px; margin: 0 auto; padding: 0 20px; font-weight: 700; font-size: 16px; text-transform: uppercase; letter-spacing: 0.5px; }
        .br-footer { background: var(--gov-blue-dark); color: white; padding: 10px 0; font-size: 11px; margin-top: auto; text-align: center; }

        /* Layout */
        .main-container {
            max-width: 1400px; margin: 30px auto; padding: 0 20px; width: 100%;
            display: grid; grid-template-columns: 320px 1fr; gap: 30px; align-items: start;
        }

        /* Painel de Controle (Sidebar) */
        .control-panel {
            background: white; border: 1px solid var(--border-color); border-radius: 4px; padding: 20px;
            position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .panel-title { font-size: 14px; font-weight: 700; color: var(--gov-blue); margin-bottom: 15px; border-bottom: 2px solid var(--gov-blue); padding-bottom: 8px; text-transform: uppercase; }

        /* Inputs e Upload */
        .form-group { margin-bottom: 15px; width: 100%; }
        .form-label { display: block; font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 5px; text-transform: uppercase; }
        .form-control {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px;
            font-size: 13px; transition: border-color 0.2s;
        }
        .form-control:focus { border-color: var(--gov-blue); }

        /* File Upload Customizado (CORRIGIDO) */
        .file-upload-wrapper {
            border: 2px dashed #ccc; 
            border-radius: 4px; 
            padding: 20px; 
            text-align: center;
            background: #fafafa; 
            cursor: pointer; 
            transition: all 0.2s;
            width: 100%; /* Ocupa tudo */
            display: flex; /* Flex para centralizar */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        .file-upload-wrapper:hover { border-color: var(--gov-blue); background: #eef6ff; }
        .file-upload-wrapper i { font-size: 24px; color: var(--gov-blue); margin-bottom: 10px; }
        .file-upload-text { font-size: 11px; color: #666; display: block; }
        input[type="file"] { display: none; }

        /* Botões */
        .btn {
            width: 100%; padding: 10px; border-radius: 3px; font-size: 12px; font-weight: 700; cursor: pointer;
            border: none; display: flex; align-items: center; justify-content: center; gap: 6px; text-transform: uppercase; margin-top: 10px;
            transition: opacity 0.2s;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: var(--gov-blue); color: white; }
        .btn-primary:hover { background: var(--gov-blue-dark); }
        .btn-success { background: var(--success); color: white; }
        
        /* Resultados (Main Area) */
        .results-area { display: flex; flex-direction: column; gap: 20px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 4px; border: 1px solid var(--border-color); text-align: center; }
        .stat-val { font-size: 24px; font-weight: 900; color: var(--gov-blue); display: block; }
        .stat-label { font-size: 10px; text-transform: uppercase; color: #777; font-weight: 700; }

        /* Logs de Erro */
        .log-box {
            background: #fff5f5; border: 1px solid #fcc; border-radius: 4px; padding: 15px;
            display: none; /* Hidden by default */
        }
        .log-title { font-size: 12px; font-weight: 700; color: var(--danger); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .log-list { list-style: none; font-size: 11px; max-height: 150px; overflow-y: auto; color: #555; }
        .log-list li { padding: 2px 0; border-bottom: 1px solid #fee; }

        /* Visualização dos Blocos */
        .blocks-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;
        }
        .block-card {
            background: white; border: 1px solid var(--border-color); border-radius: 4px;
            overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            display: flex; flex-direction: column;
        }
        .block-header {
            background: var(--gov-blue); color: white; padding: 8px 12px;
            font-size: 12px; font-weight: 700; display: flex; justify-content: space-between; align-items: center;
        }
        .block-meta {
            background: #f0f4f8; padding: 8px 12px; font-size: 11px; color: #444; border-bottom: 1px solid #eee;
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
        }
        .block-meta span { display: block; }
        
        .block-content { padding: 10px; flex: 1; }
        .box-tag {
            display: inline-block; background: #eee; color: #333;
            padding: 3px 6px; border-radius: 3px; font-size: 10px; font-weight: 700;
            margin: 2px; border: 1px solid #ddd;
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 1000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--gov-blue);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="br-header">
        <div class="header-container">
            <i class="fas fa-cubes"></i> Arquivo / Otimizador de Eliminação
        </div>
    </header>

    <main class="main-container">
        
        <aside class="control-panel">
            <div class="panel-title">Entrada de Dados</div>
            
            <div class="form-group">
                <label class="file-upload-wrapper" for="fileInput">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span class="file-upload-text" id="fileNameDisplay">Clique para selecionar Planilha (.xlsx)</span>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" onchange="handleFile(this)">
                </label>
            </div>

            <div class="panel-title" style="margin-top: 20px;">Parâmetros do Bloco</div>

            <div class="form-group">
                <label class="form-label" title="Máximo de códigos de classificação distintos no bloco">Max Códigos (un)</label>
                <input type="number" id="configMaxCodes" class="form-control" value="5">
            </div>

            <div class="form-group">
                <label class="form-label" title="Máximo de setores distintos no bloco">Max Setores (un)</label>
                <input type="number" id="configMaxSectors" class="form-control" value="3">
            </div>

            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <button class="btn btn-primary" onclick="runOptimization()" id="btnProcessar" disabled>
                    <i class="fas fa-cogs"></i> Processar Otimização
                </button>
                <button class="btn btn-success" onclick="exportarExcel()" id="btnExportar" disabled>
                    <i class="fas fa-file-excel"></i> Exportar Resultado
                </button>
                 <a href="index.html" class="btn btn-primary" style="background: white; color: #444; border: 1px solid #ccc; text-decoration: none;">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </aside>

        <section class="results-area" id="resultsArea" style="display:none;">
            
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-val" id="statTotalBoxes">0</span>
                    <span class="stat-label">Caixas Processadas</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="statTotalBlocks">0</span>
                    <span class="stat-label">Blocos Gerados</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="statAvgFill">0</span>
                    <span class="stat-label">Média Caixas/Bloco</span>
                </div>
            </div>

            <div class="log-box" id="complexLog">
                <div class="log-title"><i class="fas fa-exclamation-triangle"></i> Caixas Complexas (Sozinhas no Bloco)</div>
                <ul class="log-list" id="complexList"></ul>
            </div>

            <div class="log-box" id="crossCheckLog">
                <div class="log-title"><i class="fas fa-times-circle"></i> Caixas Rejeitadas (Erro de Dados)</div>
                <ul class="log-list" id="errorList"></ul>
            </div>

            <div class="panel-title">Visualização dos Blocos</div>
            <div class="blocks-container" id="blocksContainer">
                </div>

        </section>

        <section id="emptyState" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #999; text-align: center; padding: 50px;">
            <i class="fas fa-chart-pie" style="font-size: 60px; margin-bottom: 20px; color: #ddd;"></i>
            <p>Carregue uma planilha e clique em processar para ver a otimização.</p>
        </section>

    </main>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div style="font-weight: 700; color: var(--gov-blue);">Processando Algoritmo...</div>
    </div>

    <footer class="br-footer">
        © 2026 Desenvolvido por Vinicius A. de Souza com Claude.ai, Gemini e ChatGPT
    </footer>

    <script>
        // --- ESTADO GLOBAL ---
        let state = {
            rawData: [],
            finalBlocks: [],
            boxesMap: new Map(), 
            headers: []
        };

        // --- 1. LEITURA DE ARQUIVO ---
        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            document.getElementById('fileNameDisplay').innerText = file.name;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Consolida todas as abas
                state.rawData = [];
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    state.rawData = state.rawData.concat(json);
                });

                if(state.rawData.length > 0) {
                    state.headers = Object.keys(state.rawData[0]);
                    document.getElementById('btnProcessar').disabled = false;
                    alert(`Arquivo carregado! ${state.rawData.length} linhas importadas.`);
                } else {
                    alert("A planilha parece vazia.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 2. OTIMIZAÇÃO (CORE ALGORITHM) ---
        function runOptimization() {
            showLoading(true);

            setTimeout(() => {
                try {
                    // Parâmetros (MAX CAIXAS removido, definido como 'infinito' para o algoritmo)
                    const LIMITS = {
                        boxes: 99999, // Valor alto para simular "máximo possível"
                        codes: parseInt(document.getElementById('configMaxCodes').value) || 5,
                        sectors: parseInt(document.getElementById('configMaxSectors').value) || 3
                    };

                    // A. Pré-processamento: Agrupar documentos por BOX
                    const boxesRaw = new Map();
                    state.rawData.forEach(row => {
                        const keyBox = Object.keys(row).find(k => k.toUpperCase().trim() === 'BOX');
                        const keySetor = Object.keys(row).find(k => k.toUpperCase().trim() === 'SETOR' || k.toUpperCase().trim() === 'UNIDADE');
                        const keyCod = Object.keys(row).find(k => k.toUpperCase().trim() === 'CÓDIGO' || k.toUpperCase().trim() === 'CODIGO' || k.toUpperCase().trim() === 'COD');

                        if(keyBox && row[keyBox]) {
                            const boxId = String(row[keyBox]).trim();
                            if(!boxesRaw.has(boxId)) {
                                boxesRaw.set(boxId, {
                                    id: boxId,
                                    documentos: [],
                                    setores: new Set(),
                                    codigos: new Set()
                                });
                            }
                            const entry = boxesRaw.get(boxId);
                            entry.documentos.push({
                                ...row,
                                SETOR: keySetor ? String(row[keySetor]).trim() : "N/D",
                                COD: keyCod ? String(row[keyCod]).trim() : "N/D"
                            });
                            entry.setores.add(entry.documentos[entry.documentos.length-1].SETOR);
                            entry.codigos.add(entry.documentos[entry.documentos.length-1].COD);
                        }
                    });

                    // B. Separação: Válidos vs Inválidos
                    const validBoxes = [];
                    const rejectedBoxes = []; 
                    const complexBoxes = []; 

                    boxesRaw.forEach(box => {
                        const validation = isBoxValid(box, LIMITS);
                        if(validation.valid) {
                            validBoxes.push(box);
                        } else {
                            if(validation.reason === 'exceeds_limits_solo') {
                                complexBoxes.push(box);
                            } else {
                                rejectedBoxes.push({ id: box.id, motivo: validation.reason });
                            }
                        }
                    });

                    // C. Algoritmo Guloso (Greedy Fit)
                    let openBlocks = []; 
                    let closedBlocks = []; 

                    // Processar caixas complexas (1 por bloco)
                    complexBoxes.forEach(box => {
                        closedBlocks.push({
                            id: closedBlocks.length + 1,
                            boxes: [box],
                            codigos: box.codigos,
                            setores: box.setores,
                            isComplex: true
                        });
                    });

                    // Processar caixas normais
                    for (const box of validBoxes) {
                        let placed = false;
                        
                        // Tenta encaixar num bloco aberto existente
                        for (const block of openBlocks) {
                            if (canFit(block, box, LIMITS)) {
                                block.boxes.push(box);
                                box.codigos.forEach(c => block.codigos.add(c));
                                box.setores.forEach(s => block.setores.add(s));
                                // NOTA: Removemos a lógica de "fechar" bloco por contagem de caixas,
                                // pois o limite é "o máximo que o algoritmo conseguir".
                                placed = true;
                                break;
                            }
                        }

                        // Se não coube em nenhum, cria novo bloco
                        if (!placed) {
                            const newBlock = {
                                id: null, 
                                boxes: [box],
                                codigos: new Set(box.codigos),
                                setores: new Set(box.setores),
                                isComplex: false
                            };
                            openBlocks.push(newBlock);
                        }
                    }

                    // Move blocos restantes para finalizados
                    closedBlocks = [...closedBlocks, ...openBlocks];

                    // Renumera IDs sequencialmente
                    closedBlocks.forEach((b, i) => b.id = i + 1);

                    state.finalBlocks = closedBlocks;
                    
                    renderResults(state.finalBlocks, rejectedBoxes, complexBoxes);
                    document.getElementById('btnExportar').disabled = false;

                } catch (err) {
                    console.error(err);
                    alert("Erro ao processar: " + err.message);
                } finally {
                    showLoading(false);
                }
            }, 100);
        }

        // Verifica se cabe no bloco sem estourar limites
        function canFit(block, box, limits) {
            // 1. Limite de Caixas (Ignorado / Infinito neste caso)
            if (block.boxes.length + 1 > limits.boxes) return false;

            // 2. Limite de Códigos (União dos sets)
            const combinedCodes = new Set(block.codigos);
            box.codigos.forEach(c => combinedCodes.add(c));
            if (combinedCodes.size > limits.codes) return false;

            // 3. Limite de Setores (União dos sets)
            const combinedSectors = new Set(block.setores);
            box.setores.forEach(s => combinedSectors.add(s));
            if (combinedSectors.size > limits.sectors) return false;

            return true;
        }

        function isBoxValid(box, limits) {
            if (box.codigos.size > limits.codes) return { valid: false, reason: 'exceeds_limits_solo' };
            if (box.setores.size > limits.sectors) return { valid: false, reason: 'exceeds_limits_solo' };
            return { valid: true };
        }

        // --- 3. RENDERIZAÇÃO ---
        function renderResults(blocks, rejeitados, complexos) {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('resultsArea').style.display = 'flex';

            // Stats
            const totalBoxes = blocks.reduce((acc, b) => acc + b.boxes.length, 0);
            const avgBoxes = blocks.length > 0 ? (totalBoxes / blocks.length).toFixed(1) : 0;

            document.getElementById('statTotalBoxes').innerText = totalBoxes;
            document.getElementById('statTotalBlocks').innerText = blocks.length;
            document.getElementById('statAvgFill').innerText = avgBoxes; // Média simples agora

            // Logs
            const complexLog = document.getElementById('complexLog');
            const errorLog = document.getElementById('crossCheckLog');
            
            if(complexos.length > 0) {
                complexLog.style.display = 'block';
                document.getElementById('complexList').innerHTML = complexos.map(b => 
                    `<li><strong>Box ${b.id}:</strong> Excede limites sozinho (${b.codigos.size} Códigos / ${b.setores.size} Setores)</li>`
                ).join('');
            } else { complexLog.style.display = 'none'; }

            if(rejeitados.length > 0) {
                errorLog.style.display = 'block';
                document.getElementById('errorList').innerHTML = rejeitados.map(r => 
                    `<li><strong>Box ${r.id}:</strong> ${r.motivo}</li>`
                ).join('');
            } else { errorLog.style.display = 'none'; }

            // Blocos Grid
            const container = document.getElementById('blocksContainer');
            container.innerHTML = '';

            blocks.forEach(block => {
                const boxListHtml = block.boxes.map(b => `<span class="box-tag"><i class="fas fa-box"></i> ${b.id}</span>`).join('');
                
                // Header sem limite fixo
                const html = `
                    <div class="block-card">
                        <div class="block-header">
                            <span>BLOCO #${block.id}</span>
                            <span style="opacity:0.8">${block.boxes.length} Cxs</span>
                        </div>
                        <div class="block-meta">
                            <span><i class="fas fa-barcode"></i> ${block.codigos.size} Códigos</span>
                            <span><i class="fas fa-building"></i> ${block.setores.size} Setores</span>
                        </div>
                        <div class="block-content">
                            ${boxListHtml}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- 4. EXPORTAÇÃO ---
        function exportarExcel() {
            if(!state.finalBlocks.length) return;

            const data = [];
            state.finalBlocks.forEach(b => {
                b.boxes.forEach(box => {
                    box.documentos.forEach(doc => {
                        data.push({
                            'Bloco Sugerido': b.id,
                            'Box Original': box.id,
                            'Setor': doc.SETOR,
                            'Código': doc.COD,
                            'Tipo Documental': doc['TIPO DOCUMENTAL'] || doc['ASSUNTO'] || '',
                            'Ano': doc['ANO'] || ''
                        });
                    });
                });
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Otimizacao");
            XLSX.writeFile(wb, "Resultado_Otimizacao_Eliminacao.xlsx");
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
