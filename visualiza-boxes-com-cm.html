<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Boxes</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #0f4c81; /* Azul Institucional Clássico */
            --primary-light: #e6f0fa;
            --accent: #d4af37; /* Dourado suave (baseado no seu perfil) */
            --highlight: #10b981; /* Verde para espaço livre */
            --text: #1f2937;
            --bg: #f3f4f6;
            --box-size: 28px;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }

        .container {
            max-width: 1400px; margin: 0 auto; background: white;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex; flex-direction: column; min-height: 850px; overflow: hidden;
        }

        /* HEADER */
        .header {
            background: #fff; padding: 20px 30px; border-bottom: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 22px; color: var(--primary); margin: 0; font-weight: 700; }
        .header h1 i { margin-right: 10px; color: var(--accent); }

        /* WIZARD STATUS BAR */
        .wizard-status {
            display: flex; gap: 2px; background: #f8fafc; border-bottom: 1px solid #e5e7eb;
        }
        .step-indicator {
            flex: 1; padding: 15px; font-size: 13px; font-weight: 600; color: #94a3b8;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            border-bottom: 3px solid transparent; transition: all 0.3s;
        }
        .step-indicator.active { color: var(--primary); border-bottom-color: var(--primary); background: #fff; }
        .step-indicator.done { color: var(--highlight); border-bottom-color: var(--highlight); }
        .step-indicator i { font-size: 16px; }

        /* MAP AREA */
        .map-content { padding: 30px; flex: 1; overflow-y: auto; position: relative; }
        
        .empty-state {
            text-align: center; margin-top: 80px; color: #94a3b8;
        }
        .empty-state i { font-size: 60px; margin-bottom: 20px; opacity: 0.2; }

        /* LEGENDA */
        .legend { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; color: #555; text-transform: uppercase; }
        .dot { width: 12px; height: 12px; border-radius: 2px; }

        /* SHELVES GRID */
        .shelves-wrapper { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .shelf { background: #fff; border: 1px solid #e2e8f0; padding: 6px; border-radius: 6px; }
        .shelf-header { font-size: 10px; text-align: center; color: #94a3b8; margin-bottom: 5px; border-bottom: 1px solid #f1f5f9; }
        .shelf-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }

        /* BOX */
        .box {
            width: var(--box-size); height: var(--box-size);
            background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 3px;
            font-size: 9px; color: #cbd5e1; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative; transition: transform 0.1s;
        }
        .box:hover { z-index: 100; transform: scale(1.4); box-shadow: 0 4px 10px rgba(0,0,0,0.15); border-color: #64748b; color: #000; }

        /* VISUALIZAÇÃO */
        .box.has-docs { color: #1e293b; } /* Cor do texto quando tem docs */
        
        /* DESTAQUE DE ESPAÇO (Relevo) */
        .box.highlight-space {
            border: 2px solid var(--highlight) !important;
            box-shadow: inset 0 0 0 1px white, 0 3px 6px rgba(0,0,0,0.1) !important;
            z-index: 5;
            transform: scale(1.1);
        }
        .box.highlight-space::after {
            content: ''; position: absolute; top: -3px; right: -3px;
            width: 6px; height: 6px; background: var(--highlight); border-radius: 50%; border: 1px solid white;
        }

        /* TOOLTIP */
        .tooltip {
            position: fixed; display: none; z-index: 9999; pointer-events: none;
            background: #1e293b; color: white; padding: 12px; border-radius: 8px;
            font-size: 12px; min-width: 180px; box-shadow: 0 10px 25px rgba(0,0,0,0.25);
        }
        .tt-header { font-weight: 700; border-bottom: 1px solid #334155; padding-bottom: 5px; margin-bottom: 5px; }
        .tt-row { display: flex; justify-content: space-between; margin-bottom: 3px; }

        /* MODAL WIZARD */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .wizard-card {
            background: white; width: 500px; padding: 0; border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }
        .wizard-header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .wizard-header h2 { margin: 0; font-size: 18px; }
        .wizard-body { padding: 30px; text-align: center; }
        
        .upload-btn {
            border: 2px dashed #cbd5e1; padding: 30px; border-radius: 8px;
            background: #f8fafc; cursor: pointer; transition: 0.2s; margin-bottom: 20px;
        }
        .upload-btn:hover { border-color: var(--primary); background: var(--primary-light); }

        .btn { padding: 10px 20px; border-radius: 6px; border:none; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-text { background: transparent; color: #64748b; }
        .btn-text:hover { color: var(--text); }

    </style>
</head>
<body>

    <div id="wizardModal" class="modal-overlay">
        <div class="wizard-card">
            <div class="wizard-header">
                <h2 id="wizardTitle">Passo 1: Dados de Acervo</h2>
            </div>
            <div class="wizard-body">
                <p id="wizardDesc" style="color:#64748b; font-size:14px; margin-bottom:20px;">
                    Carregue o relatório com a contagem de documentos (Tipologias/Status).
                </p>

                <div class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" hidden accept=".xlsx, .xls">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--primary); opacity: 0.5;"></i>
                    <div style="margin-top:10px; font-weight:600; color: var(--primary);">Clique para selecionar arquivo</div>
                </div>

                <div id="skipContainer" style="display:none;">
                    <button class="btn btn-text" onclick="pularPasso()">Pular este passo</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <h1><i class="fas fa-archive"></i> Visualizador de Boxes</h1>
            <button class="btn btn-text" onclick="location.reload()"><i class="fas fa-undo"></i> Reiniciar</button>
        </header>

        <div class="wizard-status">
            <div id="step1" class="step-indicator active"><i class="fas fa-file-alt"></i> 1. Docs/Status</div>
            <div id="step2" class="step-indicator"><i class="fas fa-ruler-combined"></i> 2. Espaço Livre</div>
            <div id="step3" class="step-indicator"><i class="fas fa-check-circle"></i> 3. Visualização</div>
        </div>

        <div class="map-content">
            <div id="legendContainer" class="legend"></div>
            <div id="gridContainer" class="shelves-wrapper">
                <div class="empty-state">
                    <i class="fas fa-layer-group"></i>
                    <h3>Aguardando carregamento de dados...</h3>
                    <p>Siga as instruções na janela pop-up.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        // --- ESTADO GLOBAL ---
        const DB = {
            docs: {},
            space: {},
            meta: { hasDocs: false, hasSpace: false, statusCols: [] }
        };
        const TOTAL_BOXES = 7000;
        let currentStep = 1;

        // --- CONTROLE DO WIZARD ---
        const fileInput = document.getElementById('fileInput');
        
        fileInput.addEventListener('change', (e) => {
            if(e.target.files[0]) processarArquivo(e.target.files[0]);
        });

        function atualizarWizardUI() {
            const title = document.getElementById('wizardTitle');
            const desc = document.getElementById('wizardDesc');
            const skip = document.getElementById('skipContainer');

            if (currentStep === 1) {
                title.innerText = "Passo 1: Relatório de Status (Docs)";
                desc.innerText = "Carregue a planilha que contém a contagem de documentos por Status/Tipologia.";
                skip.style.display = 'block'; // Pode pular se só quiser ver espaços
                document.getElementById('step1').className = 'step-indicator active';
            } else if (currentStep === 2) {
                title.innerText = "Passo 2: Planilha de Espaços";
                desc.innerText = "Agora carregue a planilha com colunas 'Espaço Livre (cm)' e 'Reservado'.";
                skip.style.display = 'block';
                document.getElementById('step1').className = 'step-indicator done';
                document.getElementById('step2').className = 'step-indicator active';
            } else {
                // Fim
                document.getElementById('wizardModal').style.display = 'none';
                document.getElementById('step2').className = 'step-indicator done';
                document.getElementById('step3').className = 'step-indicator done';
                renderizarMapa();
            }
            fileInput.value = ''; // Reset input
        }

        function pularPasso() {
            currentStep++;
            atualizarWizardUI();
        }

        // --- PROCESSAMENTO ---
        function processarArquivo(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, {header: 1});

                    if(currentStep === 1) {
                        processarStatus(json);
                    } else if (currentStep === 2) {
                        processarEspacos(json);
                    }
                    
                    currentStep++;
                    atualizarWizardUI();

                } catch (err) {
                    alert("Erro ao ler arquivo: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- LÓGICA PASSO 1: STATUS/DOCS ---
        function processarStatus(rows) {
            // Tenta achar cabeçalho de forma flexível (procura "box" ou "caixa" ou "id")
            let headerIdx = -1;
            let headers = [];

            // Varre até a linha 20 para achar cabeçalho
            for(let i=0; i<Math.min(rows.length, 20); i++) {
                if(!rows[i]) continue;
                const rowStr = rows[i].map(c => String(c).toLowerCase().trim());
                // Critérios para ser cabeçalho de docs:
                if (rowStr.includes('box') || rowStr.includes('id') || rowStr.includes('caixa')) {
                    headerIdx = i;
                    headers = rows[i].map(String);
                    break;
                }
            }

            // Fallback: Se não achou "Box", assume a primeira linha não vazia que tenha mais de 2 colunas
            if (headerIdx === -1) {
                for(let i=0; i<5; i++) {
                    if(rows[i] && rows[i].length > 2) {
                        headerIdx = i;
                        headers = rows[i].map(String);
                        break;
                    }
                }
            }
            
            if (headerIdx === -1) { alert("Cabeçalho não identificado no Passo 1. Pulando."); return; }

            // Identificar colunas de Tipologia
            const ignore = ['box', 'id', 'total', 'caixa', 'unidade'];
            const statusCols = [];
            let idColIdx = 0;

            headers.forEach((h, idx) => {
                const cleanH = h.toLowerCase().trim();
                if(cleanH.includes('box') || cleanH === 'id') idColIdx = idx;
                
                if(!ignore.includes(cleanH) && isNaN(cleanH) && h.length > 2) {
                    statusCols.push({ name: h, index: idx });
                }
            });

            DB.meta.statusCols = statusCols;
            DB.meta.hasDocs = true;

            // Ler dados
            for(let i = headerIdx + 1; i < rows.length; i++) {
                const r = rows[i];
                if(!r) continue;
                
                const id = parseInt(r[idColIdx]);
                if(id > 0 && id <= TOTAL_BOXES) {
                    let total = 0;
                    let content = {};
                    statusCols.forEach(col => {
                        const val = parseInt(r[col.index]) || 0;
                        if(val > 0) {
                            content[col.name] = val;
                            total += val;
                        }
                    });
                    
                    // Salva se tiver docs ou se a linha existir (mesmo vazia)
                    if(r.length > 0) {
                        DB.docs[id] = { total, content };
                    }
                }
            }
            console.log("Passo 1 Concluído. Boxes processados.");
        }

        // --- LÓGICA PASSO 2: ESPAÇOS ---
        function processarEspacos(rows) {
             let headerIdx = -1;
             let headers = [];
             
             // Procura colunas específicas
             for(let i=0; i<Math.min(rows.length, 20); i++) {
                if(!rows[i]) continue;
                const r = rows[i].map(c => String(c).toLowerCase().trim());
                if (r.includes('reservado') || r.includes('espaço livre (cm)') || r.includes('espaço')) {
                    headerIdx = i;
                    headers = r;
                    break;
                }
             }

             if(headerIdx === -1) { alert("Colunas 'Espaço Livre' ou 'Reservado' não encontradas."); return; }

             const idxID = headers.findIndex(h => h.includes('box') || h.includes('id'));
             const idxLivre = headers.findIndex(h => h.includes('espaço'));
             const idxRes = headers.findIndex(h => h.includes('reservado'));

             if(idxID === -1 || idxLivre === -1) return;

             DB.meta.hasSpace = true;

             for(let i = headerIdx + 1; i < rows.length; i++) {
                 const r = rows[i];
                 if(!r) continue;
                 const id = parseInt(r[idxID]);
                 
                 if(id > 0 && id <= TOTAL_BOXES) {
                     DB.space[id] = {
                         livre: parseFloat(r[idxLivre]) || 0,
                         reservado: String(r[idxRes] || '').toLowerCase().includes('s') || String(r[idxRes]).toLowerCase() === 'sim'
                     };
                 }
             }
             console.log("Passo 2 Concluído.");
        }

        // --- RENDERIZAÇÃO ---
        function renderizarMapa() {
            const container = document.getElementById('gridContainer');
            const legendDiv = document.getElementById('legendContainer');
            container.innerHTML = '';
            legendDiv.innerHTML = '';

            // 1. Legenda
            const cores = gerarPaleta(DB.meta.statusCols.length);
            const mapaCores = {};

            if(DB.meta.hasDocs) {
                DB.meta.statusCols.forEach((c, i) => {
                    mapaCores[c.name] = cores[i];
                    legendDiv.innerHTML += `
                        <div class="legend-item">
                            <div class="dot" style="background:${cores[i]}"></div>${c.name}
                        </div>`;
                });
            }
            
            if(DB.meta.hasSpace) {
                legendDiv.innerHTML += `
                    <div class="legend-item" style="color:var(--highlight); margin-left:auto; border:1px solid var(--highlight); padding:4px 8px; border-radius:4px;">
                        <i class="fas fa-expand"></i> ESPAÇO LIVRE (>0cm)
                    </div>`;
            }

            // 2. Grid
            const boxesPorEstante = 49;
            const qtdEstantes = Math.ceil(TOTAL_BOXES / boxesPorEstante);
            const frag = document.createDocumentFragment();

            for(let e=0; e < qtdEstantes; e++) {
                const start = e*boxesPorEstante+1;
                const end = Math.min((e+1)*boxesPorEstante, TOTAL_BOXES);
                
                const shelf = document.createElement('div');
                shelf.className = 'shelf';
                shelf.innerHTML = `<div class="shelf-header">${start}-${end}</div>`;
                
                const grid = document.createElement('div');
                grid.className = 'shelf-grid';

                for(let i=start; i<=end; i++) {
                    const div = document.createElement('div');
                    div.className = 'box';
                    div.innerText = i;
                    
                    const doc = DB.docs[i];
                    const space = DB.space[i];

                    // Camada de Fundo (Docs)
                    if(doc && doc.total > 0) {
                        div.classList.add('has-docs');
                        div.style.background = gerarGradiente(doc, mapaCores);
                    }

                    // Camada de Espaço (Relevo)
                    // Lógica: Espaço > 0 E NÃO Reservado
                    if(space) {
                        if(space.livre > 0 && !space.reservado) {
                            div.classList.add('highlight-space');
                        }
                        if(space.reservado) {
                            div.style.color = '#ef4444'; // Texto vermelho se reservado
                        }
                    }

                    div.onmouseenter = (ev) => showTooltip(ev, i, doc, space);
                    div.onmouseleave = () => document.getElementById('tooltip').style.display='none';

                    grid.appendChild(div);
                }
                shelf.appendChild(grid);
                frag.appendChild(shelf);
            }
            container.appendChild(frag);
        }

        // --- HELPER FUNCTIONS ---
        function gerarPaleta(n) {
            const arr = [];
            for(let i=0; i<n; i++) arr.push(`hsl(${Math.floor(i * (360/n))}, 70%, 65%)`);
            return arr;
        }

        function gerarGradiente(data, mapa) {
            const entries = Object.entries(data.content);
            if(entries.length === 1) return mapa[entries[0][0]];
            let g = 'conic-gradient(';
            let acc = 0;
            entries.forEach(([k,v], idx) => {
                const p = (v/data.total)*100;
                g += `${mapa[k]} ${acc}% ${acc+p}%${idx===entries.length-1?'':', '}`;
                acc += p;
            });
            return g + ')';
        }

        function showTooltip(e, id, doc, space) {
            const tt = document.getElementById('tooltip');
            let h = `<div class="tt-header">Box ${id}</div>`;
            
            if(space) {
                if(space.livre > 0) h += `<div style="color:#34d399; font-weight:700; text-align:center; margin-bottom:5px;">✨ ${space.livre} cm Livres</div>`;
                if(space.reservado) h += `<div style="color:#f87171; font-weight:700; text-align:center;">RESERVADO</div>`;
            }

            if(doc && doc.total > 0) {
                h += `<div class="tt-row"><span>Total:</span> <strong>${doc.total}</strong></div>`;
                for(const [k,v] of Object.entries(doc.content)) {
                    h += `<div class="tt-row"><span style="opacity:0.8">${k}:</span> <span>${v}</span></div>`;
                }
            } else {
                h += `<div style="opacity:0.5; font-style:italic; font-size:11px;">Sem documentos</div>`;
            }
            
            tt.innerHTML = h;
            tt.style.display = 'block';
            
            const x = Math.min(e.clientX + 15, window.innerWidth - 200);
            const y = Math.min(e.clientY + 15, window.innerHeight - tt.offsetHeight);
            tt.style.left = x + 'px'; tt.style.top = y + 'px';
        }

        // Iniciar
        atualizarWizardUI();

    </script>
</body>
</html>